<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Please fill this form</title>
    <link rel="stylesheet" href="style.css">

    <link rel="shortcut icon" href="1.png" type="image/x-icon">

    <style>
        .loader{
            height: 100vh;
            width: 100vw;
            position: fixed;
            z-index: 9;
            top: 0;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
    </style>
</head>
<body>
    <main>
        <section class="form-section">
            <div class="form-container">
                <form action="" class="clip-form" id="videoForm" onsubmit="return validateForm()">
                    <div class="form-title">Submit Your Clip</div>
                    <div class="form-description">Your clip will be submitted to Scheema Inc, our trusted content licensing partner.</div>
                    <div class="name-container">
                        <div class="firstName-container">
                            <label for="firstName">First Name</label>
                            <input id="firstName" name="firstName" placeholder="John*" required>
                        </div>
                        <div class="lastName-container">
                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" name="lastName" placeholder="Doe*" required>
                        </div>
                    </div>
                    <div class="email-container">
                        <label for="email-input">Email</label>
                        <input type="email" id="email-input" name="email" placeholder="*Example@123.com*" required>
                    </div>
                    <div class="clip-container">
                        <div class="upload-options">
                            <div class="option-upload option active-option">
                                Upload
                            </div>
                            <div class="option-paste-link option">
                                Paste a Link
                            </div>
                            <div class="circle-content">OR</div>
                        </div>
        
                        <div class="spacer"></div>
        
                        <div class="clip-box">
                            <span class="file-name-label">No file chosen</span> 
                            <div class="clip-box-content">
                                <span class="file-input-label">Choose a file</span>
                                <input type="file" id="video" name="videoFile" accept="video/*" class="custom-file-input" onchange="displayFileName()">
                            </div>
                        </div>
                        <div class="clip-platform invisible">
                            <label for="clip-platform">Clip Platform:</label>
                            <select name="clipPlatform">
                                <option value="" disabled selected hidden> Please select clip platform...</option>
                                <option value="youtube">YouTube</option>
                                <option value="instagram">Instagram</option>
                                <option value="facebook">Facebook</option>
                                <option value="tiktok">TikTok</option>
                                <option value="twitter">Twitter</option>
                            </select>
                        </div>
                        <div class="clip-url invisible">
                            <label for="clip-url">Clip URL:</label>
                            <input id="clip-url" name="videoLink" placeholder="Clip URL*">
                        </div>
                        <h5>Please submit unedited clips without text or music</h5>
                    </div>
                    <div class="submit-rules">
                        <h2>Don't submit clips that:</h2>
                        <ul class="rules">
                            <li>Aren't yours</li>
                            <li>Include music or text</li>
                            <li>Violate copyright laws</li>
                            <li>Feature graphic violence or nudity</li>
                        </ul>
                    </div>
                    <div class="clip-info-container">
                        <div class="filmed-location">
                            <label for="filmed-location">Where was this filmed?</label>
                            <input id="filmed-location" name="filmedLocation" placeholder="At Home*">
                        </div>
                        <div class="optional-description">
                            <label>Add clip description? (optional)</label>
                            <div class="description-options">
                                <div class="description-option active-option" id="description-option-yes">
                                    Yes
                                </div>
                                <div class="description-option" id="description-option-no">
                                    No
                                </div>
                            </div>
                            <div class="text-area-container">
                                <label for="clip-description">Tell us about your clip</label>
                                <textarea id="clip-description" name="clipDescription" cols="30" rows="10"></textarea>
                                <div class="textarea-description">A detailed description gives your clip a better chance of being featured</div>
                            </div>
                        </div>
                        <div class="clip-recorder">
                            <div class="clip-recorder-question">
                                <h5>Did you record this clip?</h5>
                            </div>
                            <div class="description-options" id="clip-recorder-options">
                                <div class="description-option active-option" id="clip-recorder-yes">
                                    Yes
                                </div>
                                <div class="description-option" id="clip-recorder-no">
                                    No
                                </div>
                            </div>
                            <div class="clip-recorder-container invisible" id="clip-recorder-input">
                                <label for="clip-recorder">Who recorded this clip?</label>
                                <input type="text" id="clip-recorder" name="clipRecorder" placeholder="Myself*">
                            </div>
                        </div>
                        <div class="optional-credit">
                            <h5>Do you want credit for this clip?</h5>
                            <div class="description-options credit-options">
                                <div class="description-option active-option" id="optional-credit-yes">
                                    Yes
                                </div>
                                <div class="description-option" id="optional-credit-no">
                                    No
                                </div>
                            </div>
                            <div class="credit-info" id="optional-credit-content">
                                <label for="credit-info-platform">Platform</label>
                                <select name="creditPlatform">
                                    <option value="" disabled selected hidden> Please select...</option>
                                    <option value="youtube">YouTube</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="tiktok">TikTok</option>
                                    <option value="twitter">Twitter</option>
                                    <option value="other">Other</option>
                                </select>
                                <label for="credit-info-handle">Handle or Username to credit</label>
                                <input id="credit-info-handle" name="creditHandle" placeholder="e.g: Mike Tyson">
                            </div>
                        </div>
  
                    </div>
                    <div class="digital-signature-container">

                        <button class="submit">Submit</button>
                    </div>
                </form>
            </div>
        </section>




        <div class="loader">
            <p>Loading</p>
        </div>
    </main>

</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>







<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('video');
        const fileNameLabel = document.querySelector('.file-name-label');

        function displayFileName() {
            if (fileInput.files.length > 0) {
                fileNameLabel.textContent = fileInput.files[0].name;
            } else {
                fileNameLabel.textContent = 'No file chosen';
            }
        }

        fileInput.addEventListener('change', displayFileName);

        const container = document.querySelector('.clip-box-content');
        container.addEventListener('click', function () {
            fileInput.click();
        });

        const uploadOptions = document.querySelectorAll('.option');
        uploadOptions.forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.option').forEach(opt => opt.classList.remove('active-option'));
                this.classList.add('active-option');

                const isPasteLink = this.classList.contains('option-paste-link');
                document.querySelector('.clip-platform').classList.toggle('invisible', !isPasteLink);
                document.querySelector('.clip-url').classList.toggle('invisible', !isPasteLink);
                document.querySelector('.clip-box').classList.toggle('invisible', isPasteLink);
            });
        });

        // OAuth 2.0 Dropbox setup
        const DROPBOX_CLIENT_ID = 'ekpf8o9wpkutry2'; 
        const DROPBOX_CLIENT_SECRET = 'srt05sy5qy36zxg'; // Add your app secret here
        const DROPBOX_REDIRECT_URI = 'https://tocjpapi.github.io/Scheema/form2.html';

        // Initialize Dropbox authentication
        const dbxAuth = new Dropbox.DropboxAuth({
            clientId: DROPBOX_CLIENT_ID
        });

        // Function to start OAuth 2.0 flow with code grant
// Function to start OAuth 2.0 flow with code grant
async function authenticateWithDropbox() {
    try {
        const authUrl = await dbxAuth.getAuthenticationUrl(DROPBOX_REDIRECT_URI, null, 'code', 'offline', null, null, 'none');
        window.location.href = authUrl;
    } catch (error) {
        console.error('Error initiating Dropbox authentication:', error);
    }
}


        
        // Check if redirected back with an authorization code
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const accessToken = localStorage.getItem('access_token');
        const refreshToken = localStorage.getItem('refresh_token');

        let dropbox;

        if (accessToken) {
            // If an access token is already stored, use it to initialize Dropbox
            dropbox = new Dropbox.Dropbox({ accessToken });
        } else if (code) {
            // Exchange the authorization code for access and refresh tokens
            const exchangeTokenUrl = `https://api.dropbox.com/oauth2/token`;

            // Exchange code for access token (with client secret)
            const tokenData = {
                code: code,
                grant_type: 'authorization_code',
                client_id: DROPBOX_CLIENT_ID,
                client_secret: DROPBOX_CLIENT_SECRET,
                redirect_uri: DROPBOX_REDIRECT_URI
            };

            fetch(exchangeTokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(tokenData)
            })
            .then(response => response.json())
            .then(data => {
                const { access_token, refresh_token } = data;

                // Store tokens in localStorage for later use
                localStorage.setItem('access_token', access_token);
                localStorage.setItem('refresh_token', refresh_token);

                // Initialize Dropbox with the new access token
                dropbox = new Dropbox.Dropbox({ accessToken: access_token });
            })
            .catch((error) => {
                console.error('Error exchanging code for access token:', error);
            });
        } else if (refreshToken) {
            // If refresh token exists, use it to obtain a new access token
            const refreshTokenData = {
                refresh_token: refreshToken,
                grant_type: 'refresh_token',
                client_id: DROPBOX_CLIENT_ID,
                client_secret: DROPBOX_CLIENT_SECRET
            };

            fetch('https://api.dropbox.com/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(refreshTokenData)
            })
            .then(response => response.json())
            .then(data => {
                const newAccessToken = data.access_token;

                // Update stored access token
                localStorage.setItem('access_token', newAccessToken);

                // Initialize Dropbox with the refreshed access token
                dropbox = new Dropbox.Dropbox({ accessToken: newAccessToken });
            })
            .catch((error) => {
                console.error('Error refreshing access token:', error);
            });
        } else {
            // Start OAuth flow if no token is available
            authenticateWithDropbox();
        }

        // Submit form and upload files to Dropbox
        const form = document.getElementById('videoForm');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                if (!validateForm()) {
                    return;
                }

                // Show loader
                document.querySelector('.loader').style.display = 'flex';

                const formData = new FormData(form);
                const firstName = formData.get('firstName');
                const lastName = formData.get('lastName');
                const email = formData.get('email');
                const filmedLocation = formData.get('filmedLocation');
                const clipDescription = formData.get('clipDescription') || 'No description provided';
                const creditPlatform = formData.get('creditPlatform') || 'N/A';
                const creditHandle = formData.get('creditHandle') || 'N/A';
                const clipRecorder = formData.get('clipRecorder') || 'N/A';
                const videoFile = formData.get('videoFile');
                const videoLink = formData.get('videoLink') || 'N/A';
                const platform = formData.get('clipPlatform') || 'N/A';

                if (!firstName || !lastName || !email) {
                    throw new Error('Required fields are missing.');
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                // Set margins and page size
                const margin = 20;
                const pageWidth = pdf.internal.pageSize.width;
                const pageHeight = pdf.internal.pageSize.height;
                const maxWidth = pageWidth - 2 * margin;

                pdf.setFontSize(12);

                const licenseText = ``;

                const textLines = [
                    licenseText,
                    `Name: ${firstName} ${lastName}`,
                    `Email: ${email}`,
                    `Filmed Location: ${filmedLocation}`,
                    `Clip Description: ${clipDescription}`,
                    `Credit Platform: ${creditPlatform}`,
                    `Credit Handle: ${creditHandle}`,
                    `Clip Recorder: ${clipRecorder}`,
                    `Clip Platform: ${platform}`,
                    `Clip URL: ${videoLink}`
                ];

                let yPosition = margin;

                textLines.forEach((line, index) => {
                    const lines = pdf.splitTextToSize(line, maxWidth);

                    lines.forEach(splitLine => {
                        if (yPosition > pageHeight - margin) {
                            pdf.addPage();
                            yPosition = margin;
                        }
                        pdf.text(splitLine, margin, yPosition);
                        yPosition += 7; // Approximate line height
                    });

                    // Add extra space between form fields
                    yPosition += 5;
                });

                const timestamp = Date.now();
                const folderPath = `/submission_${timestamp}`;
                const pdfFileName = `${firstName}_${lastName}_${timestamp}.pdf`;

                const pdfBlob = pdf.output('blob');

                // Create folder and upload to Dropbox
                await dropbox.filesCreateFolderV2({ path: folderPath });

                // Upload PDF to Dropbox
                await dropbox.filesUpload({
                    path: `${folderPath}/${pdfFileName}`,
                    contents: pdfBlob,
                    mode: 'add',
                    autorename: true,
                    mute: false
                });

                // Upload Video if present
                if (videoFile && videoFile.size > 0) {
                    const videoFileName = videoFile.name;
                    await dropbox.filesUpload({
                        path: `${folderPath}/${videoFileName}`,
                        contents: videoFile,
                        mode: 'add',
                        autorename: true,
                        mute: false
                    });
                } else if (videoLink !== 'N/A') {
                    // If a video link was provided instead of a file, save it in a text file
                    const linkFileName = 'video_link.txt';
                    const linkBlob = new Blob([videoLink], { type: 'text/plain' });
                    await dropbox.filesUpload({
                        path: `${folderPath}/${linkFileName}`,
                        contents: linkBlob,
                        mode: 'add',
                        autorename: true,
                        mute: false
                    });
                }

                // Hide loader
                document.querySelector('.loader').style.display = 'none';

                window.location.href = 'done.html';

            } catch (error) {
                console.error('Form submission error:', error);
                alert('An error occurred during form submission. Please try again.');
                // Hide loader in case of error
                document.querySelector('.loader').style.display = 'none';
            }
        });

        function validateForm() {
            const form = document.getElementById('videoForm');
            const firstName = form.elements['firstName'].value.trim();
            const lastName = form.elements['lastName'].value.trim();
            const email = form.elements['email'].value.trim();

            if (firstName === '' || lastName === '' || email === '') {
                alert('Please fill in all required fields.');
                return false;
            }

            return true;
        }
    });
</script>







<script src="scripts.js"></script>

</html>